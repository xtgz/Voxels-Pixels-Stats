function loadStorages(e){e?chrome.storage.local.get("user_info",async function(e){let t=e.user_info;try{let a=await makeFetchRequest(apiURL,{name:t,operation:"getStorage"});handleErrors(a)||("logout"==a?initiate():loadStoragePage(a.data))}catch(r){console.error(r)}}):chrome.storage.local.get("storage_data",function(e){e.storage_data?loadStoragePage(e.storage_data):loadStoragePage([])})}function loadStoragePage(e){let t=document.querySelector(".voxels-main");var a=document.createElement("div");a.classList.add("voxels-main-page"),a.classList.add("active"),t.appendChild(a),setStorages(e),reloadFooter()}function setStorages(e){for(let t in e)createStorage(e[t],t)}function createStorage(e,t){var a,r,o=document.querySelector(".voxels-storage-"+t);if(o)(r=(a=o).querySelector(".voxels-storages-container")).innerHTML="";else{(a=document.createElement("div")).classList.add("voxels-main-storage"),a.classList.add("voxels-storage-"+t);var n=document.createElement("div");n.classList.add("voxels-main-storage-header"),a.appendChild(n);var s=document.createElement("div");s.classList.add("voxels-main-storage-text"),s.textContent=t,n.appendChild(s);var i=document.createElement("div");i.classList.add("voxels-main-storage-buttons"),n.appendChild(i);var l=document.createElement("img");l.classList.add("voxels-storage-update"),l.src=chrome.runtime.getURL("/images/icons/icon__refresh.svg"),l.addEventListener("click",function(){isAddingStorage||intervalActive?showAlert("Cannot add storage while processing.","error"):(isAddingStorage=!0,updateStorage(0,t))}),i.appendChild(l);var d=document.createElement("div");d.classList.add("voxels-main-remove");var c=document.createElement("div");c.classList.add("voxels-remove-icon"),c.textContent="X",d.addEventListener("click",function(){removeStorage(t)}),d.appendChild(c),i.appendChild(d);var r=document.createElement("div");r.classList.add("voxels-storages-container")}if(e.forEach(e=>{if("0"===e){var t=document.createElement("div");t.classList.add("voxels-storageItem"),r.appendChild(t)}else{var a=e.display_name,o=e.image,n=e.quantity,t=document.createElement("div");t.classList.add("voxels-storageItem");var s=document.createElement("img");s.src=o,t.appendChild(s);var i=document.createElement("div");i.classList.add("voxels-storage-quantity"),i.textContent=n,t.appendChild(i),t.addEventListener("mouseenter",function(){var e=document.createElement("div");e.classList.add("voxels-hover-box"),e.textContent=a,document.body.appendChild(e);var r=t.getBoundingClientRect();e.style.position="absolute",e.style.top=r.top-e.offsetHeight+"px",e.style.left=r.left-50+"px"}),t.addEventListener("mouseleave",function(){let e=document.querySelectorAll(".voxels-hover-box");e.forEach(function(e){e.parentNode&&e.parentNode.removeChild(e)})}),r.appendChild(t)}}),a.appendChild(r),!o){var g=document.querySelector(".voxels-main-page");g&&g.appendChild(a)}reloadFooter()}function updateStorage(e,t){0===e&&(e=getCurrentStorage()),!1!==e?chrome.storage.local.get("user_info",async function(a){let r=a.user_info,o={name:r,operation:"updateStorage",extra:{storageName:t,items:e.items}};try{let n=await makeFetchRequest(apiURL,o);n=n.data,"correct"===n.status?correctStorage(e,n,t,updateStorage):"success"===n.status?(createStorage(n.display_names_images,t),chrome.storage.local.get("storage_data",function(e){let a=e.storage_data||{};a[t]=n.display_names_images,chrome.storage.local.set({storage_data:a})})):handleStorageError(n),isAddingStorage=!1}catch(s){console.error(s)}}):(isAddingStorage=!1,showAlert("Please open a valid storage.","error"))}function removeStorage(e){confirmRemoval(e,function(t){t&&chrome.storage.local.get("user_info",async function(t){let a=t.user_info;try{let r=await makeFetchRequest(apiURL,{name:a,operation:"removeStorage",extra:e});if("success"===r.data){let o=`.voxels-storage-${e}`,n=document.querySelector(o);n.remove(),chrome.storage.local.get("storage_data",function(t){let a=t.storage_data||{};delete a[e],chrome.storage.local.set({storage_data:a})}),reloadFooter()}}catch(s){console.error(s)}})})}function confirmRemoval(e,t){var a=document.createElement("div");a.classList.add("voxels-popup-storage","voxels-popup-info"),a.innerHTML='<h3>Are you sure you want to remove storage:"'+e+'"?</h3><button id="confirmButton">Yes</button>';var r=document.createElement("div");function o(){a.remove()}r.className="voxels-popup-close",r.innerHTML="X",a.appendChild(r),document.body.appendChild(a),r.addEventListener("click",o),document.getElementById("confirmButton").addEventListener("click",function(){t(!0),o()})}function reloadFooter(){let e=document.querySelector(".voxels-main-page"),t=document.querySelectorAll(".voxels-main-new");t.forEach(e=>{e.remove()});let a=document.querySelectorAll(".voxels-main-premium");a.forEach(e=>{e.remove()});let r=e.querySelectorAll(".voxels-main-storage").length;r<40&&(r>0?premium&&addStorageButton():addStorageButton()),premium||displayPremium()}let isAddingStorage=!1,intervalActive=!1;function addStorageButton(){let e=document.querySelector(".voxels-main");var t=document.createElement("div");t.classList.add("voxels-main-new","pixel-border"),e.appendChild(t),t.innerHTML="Add current storage",t.addEventListener("click",function(){isAddingStorage||intervalActive?showAlert("Cannot add storage while processing.","error"):(isAddingStorage=!0,addStorage(0,""))})}function getStorageName(e){var t=document.createElement("div");t.className="voxels-popup-storage",t.innerHTML='<h3>Enter Storage Name:</h3><input type="text" id="storageNameInput" placeholder="Enter storage name..."><button id="submitButton">OK</button>',t.classList.add("voxels-popup-info");var a=t.querySelector("#storageNameInput");a.addEventListener("keydown",function(e){document.activeElement===a&&e.stopPropagation()});var r=document.createElement("div");r.className="voxels-popup-close",r.innerHTML="X",t.appendChild(r),document.body.appendChild(t),r.addEventListener("click",function(){t.remove(),isAddingStorage=!1}),document.getElementById("storageNameInput").focus(),document.getElementById("submitButton").addEventListener("click",function(){var a=document.getElementById("storageNameInput").value.trim();/^[a-zA-Z0-9]+$/.test(a)?a.length<=10?(e(a),t.remove()):(isAddingStorage=!1,showAlert("Please enter a storage name with a maximum of 10 characters.","error")):(isAddingStorage=!1,showAlert("Please enter a storage name containing only letters or numbers.","error"))})}function addStorage(e,t){if(0===e&&(e=getCurrentStorage()),!1!==e){if(""===t){getStorageName(function(t){addStorage(e,t)});return}sendStorageRequest(e.items,t).then(a=>{"correct"===a.status?correctStorage(e,a,t,addStorage):"success"===a.status?(createStorage(a.display_names_images,t),chrome.storage.local.get("storage_data",function(e){let r=e.storage_data||{};Array.isArray(r)&&(r=convertArrayToObject(r)),r[t]=a.display_names_images,chrome.storage.local.set({storage_data:r})})):handleStorageError(a),isAddingStorage=!1}).catch(e=>{console.error(e),isAddingStorage=!1})}else isAddingStorage=!1,showAlert("Please open a valid storage.","error")}function correctStorage(e,t,a,r){intervalActive=!0;let o=0,n=t.item_names,s=[];for(let i=0;i<n.length;i++){if("multiple"===n[i]){let l=e.elements[o];if(l.classList.add("voxels-multiple"),l){let d=l.querySelector(nodeNames.storageItemBackground);d&&(d.style.filter="brightness(110%) hue-rotate(130deg)",s.push({imgElement:d,index:o}))}}o++}if(0===s.length){intervalActive=!1;return}showAlert("Couldn't identify all items. Hover over the red items.","info");let c=setInterval(function t(){if(!document.querySelector(nodeNames.storageBox)){clearInterval(c),intervalActive=!1,showAlert("Stopped adding storage.","info");return}for(let o=0;o<s.length;o++){let{imgElement:n,index:i}=s[o],l=checkForToolTip(n),d=n.closest(nodeNames.storageItem).querySelector(nodeNames.storageQuantity),g=d?d.textContent.trim():"0";!1!==l&&(e.items[i]={type:"name",data:l,position:i,quantity:g},s.splice(o,1),o--)}0===s.length&&(clearInterval(c),intervalActive=!1,r(e,a))},100)}function checkForToolTip(e){let t=e.closest(nodeNames.storageItem);if(t){let a=t.getAttribute("aria-labelledby");if(a){let r=document.getElementById(a);if(r){let o=r.querySelector(".pixelFont").innerHTML.split("<br>")[0];return e.style.filter="",o}}}return!1}function sendStorageRequest(e,t){return new Promise(async(a,r)=>{chrome.storage.local.get("user_info",async function(o){let n={name:o.user_info,operation:"addStorage",extra:{storageName:t,items:e}};try{let s=await makeFetchRequest(apiURL,n);a(s.data)}catch(i){r(i)}})})}function getCurrentStorage(){let e=document.querySelectorAll(nodeNames.storageBox),t=[];return e.length>0&&(t.elements=e,storageItems=[],e.forEach((e,t)=>{let a=e.querySelector(nodeNames.storageImage),r=e.querySelector(nodeNames.storageQuantity);if(a&&r){if(a.complete){let o=calculateAverageColor(a);storageItems.push({type:"hash",data:o,position:t,quantity:r.textContent})}}else storageItems.push({position:t})}),t.items=storageItems,t)}function handleStorageError(e){e&&e.status&&e.status.error&&("4002"===e.status.error?showAlert("A storage with this name already exists.","error"):showAlert("An error occurred. Please try again.","error"))}
let inventoryPending=!1;var currentFetchedInventory=[],inventoryModeTotal=!1,displayInventoryPrice=!0;function loadInventoryPrices(){let e=document.querySelectorAll(nodeNames.hudItems);if(e.length>0&&!inventoryPending){let t=[],n=[];e.forEach(e=>{let i=e.querySelector(nodeNames.hudItemImage);if(i){if(i.complete){let r=calculateAverageColor(i);t.push(r),n.push(e)}else i.onload=function(){let r=calculateAverageColor(i);t.push(r),n.push(e)}}}),t.length>0&&(inventoryPending=!0,sendRequestByHash(t).then(e=>{console.log(e),setPricesInInventory(e,n),inventoryPending=!1}).catch(e=>{console.error(e),inventoryPending=!1}))}}function togglePrices(){let e=document.querySelectorAll(".voxels-inventory-price");e.forEach(function(e){displayInventoryPrice?e.style.display="":e.style.display="none"});let t=document.querySelector(".voxels-inventory-total");t&&(displayInventoryPrice?t.style.display="":t.style.display="none")}function getInventoryWithQuantities(e){let t={},n=document.querySelectorAll(nodeNames.hudItems),i=0;n.forEach((n,r)=>{let l=n.querySelector(nodeNames.clickable);if(l){let o=n.querySelector(nodeNames.hudQuantities);if(o){let a=e[i],s=o.textContent.replace("x","");s=""===s?1:parseInt(s,10),t[a.displayName]?t[a.displayName]+=s:t[a.displayName]=s}i++}}),currentFetchedInventory=Object.entries(t).map(([e,t])=>({displayName:e,quantity:t}))}function setPricesInInventory(e,t){let n=0;function i(e){return e>9999?nFormatter(e,1):e}e.forEach((e,r)=>{let l=t[r];if(null!==e.price.price){let o=l.querySelector(".voxels-inventory-price"),a=e.price.price,s=l.querySelector(nodeNames.hudQuantities).textContent,c=s&&s.length>1?parseInt(s.substring(1),10):1,d=a*c;if(n+=d,inventoryModeTotal&&(a=d),o){o.innerText=i(a);let u=document.createElement("img");inventoryModeTotal?u.src=chrome.runtime.getURL("images/Prices/coin_total.png"):u.src=chrome.runtime.getURL("images/Prices/coin.png"),o.appendChild(u),o.classList.add("voxels-blinking"),setTimeout(()=>{o.classList.remove("voxels-blinking")},500)}else{var g=document.createElement("div");g.classList.add("voxels-inventory-price"),g.innerText=i(a);let y=document.createElement("img");inventoryModeTotal?y.src=chrome.runtime.getURL("images/Prices/coin_total.png"):y.src=chrome.runtime.getURL("images/Prices/coin.png"),g.appendChild(y),l.appendChild(g),g.classList.add("voxels-blinking"),setTimeout(()=>{g.classList.remove("voxels-blinking")},500)}}});let r=document.querySelector(nodeNames.hudSliding);var l=document.querySelector(".voxels-inventory-total");l||(l=document.createElement("div")),l.classList.add("voxels-inventory-total"),l.innerText=i(n);let o=document.createElement("img");o.src=chrome.runtime.getURL("images/Prices/coin_total.png"),l.appendChild(o),r.appendChild(l)}async function sendRequestByHash(e){return new Promise(async(t,n)=>{chrome.storage.local.get("user_info",async function(i){let r={name:i.user_info,operation:"fetchPricesByHash",extra:e};try{let l=await makeFetchRequest(apiURL,r),o=l.data;userPremium&&"tasks"==currentActiveTab&&(getInventoryWithQuantities(o),setTaskQuantities());let a=e.map((e,t)=>({averageColor:e,price:o[t]}));t(a)}catch(s){n(s)}})})}function calculateAverageColor(e){let t=document.createElement("canvas"),n=t.getContext("2d");t.width=e.width,t.height=e.height,n.drawImage(e,0,0,e.width,e.height);let i=n.getImageData(0,0,e.width,e.height).data,r=0,l=0,o=0;for(let a=0;a<i.length;a+=4)r+=i[a],l+=i[a+1],o+=i[a+2];let s=i.length/4,c=r/s,d=l/s,u=o/s,g=generateColorHash(c,d,u);return g}function generateColorHash(e,t,n){let i=`${Math.round(e)},${Math.round(t)},${Math.round(n)}`,r=0;for(let l=0;l<i.length;l++){let o=i.charCodeAt(l);r=(r<<5)-r+o}let a=(r>>>0).toString(16);return a}